<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <link rel="stylesheet" type="text/css" href="dw.css"/>
    <script>
    if (window.location.protocol === "http:" && window.location.port !== "3000") {
        window.location = window.location.href.replace("http:", "https:")
    }

    </script>
</head>
<body>

    <div id="game-display">
    
        <div id="background">
            <canvas id="backgroundCanvas"></canvas>    
        </div>
        <canvas tabindex="1" id="mainCanvas"></canvas>
        <div id="beat-indicator"></div>
        <img id="onscreen-display"></img>

    </div>
    
    <script src="/js/omgservice.js"></script>
    <script type="module">
        import OMGGameEngine from "./game_engine.js"

        var gameUI = document.getElementById("game-display")

        let borderX = 0
        let borderY = 0
        let width = 1920
        let height = 1080
        let ratio =  width / height
        let winRatio = window.innerWidth / window.innerHeight
        
        if (ratio > winRatio) {
            borderY = (window.innerHeight - window.innerWidth / ratio) / 2

            gameUI.style.height = window.innerHeight + "px" //- (borderY * 2) + "px"
            gameUI.style.borderTop = borderY + "px solid black"
            gameUI.style.borderBottom = borderY + "px solid black"

        }
        else if (ratio < winRatio) {
            //borderX = (window.innerHeight - window.innerWidth / ratio) / 2
            borderX = (window.innerWidth - window.innerHeight * ratio) / 2

            
            gameUI.style.width = window.innerWidth + "px" //- (borderX * 2) + "px"
            gameUI.style.borderLeft = borderX + "px solid black"
            gameUI.style.borderRight = borderX + "px solid black"

        }

        //gameUI.style.backgroundColor = "red"
        console.log(ratio, winRatio, borderY)





        var ge
        var params = omg.util.getPageParams()
        if (params.id) {
            omg.server.getId(params.id, data => {

                ge = new OMGGameEngine()
                window.ge = ge
                ge.loadMap(data, location.href)

                var charSprite = window.location.host.startsWith("localhost") ? "https://localhost:8081/data/854" : "https://wesandm.com/data/64"
                fetch(charSprite).then(res => res.json()).then(data => {

                    ge.loadHero(data)
    
                })

                /*var charlieSprite = "https://wesandm.com/data/226"
                fetch(charlieSprite).then(res => res.json()).then(data => {

                    ge.loadCar(data)
    
                })*/
    
                var gameUIUrl = "https://wesandm.com/data/292"
                fetch(gameUIUrl).then(res => res.json()).then(data => {
                    var gameOSD = document.getElementById("onscreen-display")
                    gameOSD.src = Object.values(data.sheets)[0].url

                    gameOSD.onload = e => gameOSD.style.display = "block"
                    

                })

                
            })
        }

    </script>
</body>
</html>