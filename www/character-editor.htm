<!DOCTYPE html>
<html>
    <head>

        <link rel="stylesheet" href="/css/main.css" type="text/css" />

        <style>
            .url-input {width: 300px;}
            /*button {width: 100%; height: 40px; background-color: blue;}*/
            textarea {width: 400px; height: 100px;}

            #drop-zone {
                border:2px dashed #808080;
                padding: 30px;
                margin: 20px;
                text-align: center;
            }
            .drop-zone-hover {
                background-color:#DDDDFF;
                border:2px dotted #808080 !important;
            }

            .search-thing-menu {
                cursor: pointer;
                margin:4px;
                display:inline-block;
                /*float:right;*/
            }

            .search-thing-menu:hover {
                border-radius: 2px;
                border: 1px solid #808080;
                margin:3px;
            }

            #url-section {
                display: flex;
                align-items: center;
                margin-top: 15px;
                    
            }

            #url-section input {
                flex-grow: 1;
                margin-left: 12px;
            }

        </style>

    </head>
    <body>

        <header>
            <a class="main-page-link" href="/">
                <span class="main-title-open">Open</span><span class="main-title-media">Media</span><span class="main-title-gallery">.Gallery</span>
            </a>
            <div class="title-bar-user-controls"></div>
        </header>

        <div class="main-body">

            <h1>Add/Edit a Character</h1>

            Character Name: 
            <br>
            <input id="thing-name">

            <hr>
            width <input id="char-width">
            height <input id="char-height">

            <hr>
            Image: 
            <div id="url-section">Url: <input placeholder="give a url or drop an image below" id="image-url"></div>
            <div id="drop-zone">
                <div id="drop-caption">Drop Files Here To Upload</div>
                <img id="image-img" src="">
            
            </div>    

            <hr>

            <button class="main-create-something" id="submit-button">Submit</button>

        </div>

        <script src="/js/usercontrols.js"></script>

        <script src="/js/omgservice.js"></script>
        <script>

var inputsDiv = document.getElementById("inputs")
var inputs = {
    name: document.getElementById("thing-name"),
    images: [document.getElementById("image-url"),]
};
var thing = {}
thing.type = "CHARACTER"
thing.omgVersion = 1
thing.images = [{}]

var params = omg.util.getPageParams();

var imageEl = document.getElementById("image-img")
var dropCaption = document.getElementById("drop-caption")

inputs.images[0].onkeypress = e => {
    if (e.keyCode === 13) {
        setImage(e.value)
    }
}

var setImage = url => {
    inputs.images[0].value = url
    thing.images[0].url = url 
    imageEl.src = url
    dropCaption.style.display = "none"
    
}

var setupPage = () => {
    if (params.id) {
        omg.server.getId(params.id, function (response) {

            thingInputs(response)

            var newDiv;
            thing = response
        });
    }
}

var thingInputs = (data) => {
    inputs.name.value = data.name
    setImage(data.images[0].url)
}

var setList = (data) => {
    inputsDiv.innerHTML = ""
    inputs.data = []

    for (var code in data.tileCodes) {
        makeListItem(code, data.tileCodes[code])
    }
}

var makeListItem = (code, data) => {
    console.log(code, data)
    var div = document.createElement("div")
    div.innerHTML = "Item " + (inputs.data.length + 1) + " Code: "
    var nameInput = document.createElement("input")
    nameInput.value = code
    div.appendChild(nameInput)
    var caption = document.createElement("span")
    caption.innerHTML = "URL: "
    div.appendChild(caption)
    var urlInput = document.createElement("input")
    urlInput.value = data
    div.appendChild(urlInput)
    inputsDiv.appendChild(div)
    var statusDiv = document.createElement("span")
    div.appendChild(statusDiv)

    urlInput.addEventListener("paste", function (e) {
        if (nameInput.value.length == 0) {

            var filename;
            filename = e.clipboardData.getData("Text");

             nameInput.value = makeSoundName(filename) //todo
             data.name = nameInput.value
        }
    }, false);
    //urlInput.onchange = ()=>data.url = urlInput.value
    //nameInput.onchange = ()=>data.name = nameInput.value

    var el = document.createElement("div")
    el.innerHTML = "&times;"
    el.className = "search-thing-menu"
    div.appendChild(el)
    el.onclick = (e) => {
        e.stopPropagation()
        remove(data)
    }

    el = document.createElement("div")
    el.innerHTML = "&darr;"
    el.className = "search-thing-menu"
    div.appendChild(el)
    el.onclick = (e) => {
        e.stopPropagation()
        moveDown(data)
    }

    el = document.createElement("div")
    el.innerHTML = "&uarr;"
    el.className = "search-thing-menu"
    div.appendChild(el)
    el.onclick = (e) => {
        e.stopPropagation()
        moveUp(data)
    }

    inputs.data.push({nameInput: nameInput, urlInput, urlInput})
    return statusDiv
}

var makeSoundName = (filename) => {
    return filename.split("/").pop().split(".")[0].replace("_", " ").replace("-", " ")
}

var dropZone = document.getElementById("drop-zone")
dropZone.ondragover = (e) => {
    e.preventDefault()
    dropZone.className = "drop-zone-hover"
}
dropZone.ondragleave = (e) => {
    e.preventDefault()
    dropZone.className = ""
}
dropZone.ondrop = (e) => {
    e.preventDefault()
    var handleDroppedItems = (items) => {
        for (var i = 0; i < e.dataTransfer.items.length; i++) {
            if (e.dataTransfer.items[i].kind === "file" && 
                    e.dataTransfer.items[i].type.startsWith("image/")) {
                handleDroppedItem(e.dataTransfer.items[i])
            }
        }
    }
    dropZone.className = ""

    var handleDroppedItem = (item) => {
        var file = item.getAsFile()
        
        //statusDiv.innerHTML = "Uploading..."
        
        var fd = new FormData();
        fd.append('setId', thing.id);
        fd.append('file', file);
        fd.append('filename', file.name);
        
        omg.server.postHTTP("/upload", fd, (res)=>{
            url = window.location.origin + res.filename
            setImage(url)
            //statusDiv.innerHTML = res.success ? 
            //    "<font color='green'>Uploaded</font>" : ("<font color='red'>Error</font> " + res.error)
        });
    }

    if (e.dataTransfer.items) {
        if (thing.id) {
            handleDroppedItems(e.dataTransfer.items)
        }
        else {
            submit((res) => {
                thing.id = res.id
                handleDroppedItems(e.dataTransfer.items)
            })
        }
    }
}

document.getElementById("submit-button").onclick = function () {
    console.log("1", thing.id)
    if (!inputs.name.value) {// || inputs.data.length == 0) {
        alert("thing needs a name, and a sound with a caption and url.")
        return
    }

    submit((res)=>{
        console.log("2", res)
        if (res.id > 0) {
            window.location = "character.htm?id=" + res.id;
        }
    })
}

var submit = (cb) => {

    thing.name = document.getElementById("thing-name").value
    thing.src = document.getElementById("image-img").src

    omg.server.post(thing, function (response) {
        if (response.id) {
            thing.id = response.id
        }
        if (cb) {
            cb(response)
        }
    });
};


omg.server.getUser(user => {
    if (!user) {
        window.location = "/signin.htm?fwd=" + encodeURIComponent(window.location.href)
    }
    else {
        setupPage()
    }
})
        </script>
    </body>
</html>
