<!DOCTYPE html>
<html>
    <head>
        <style>
            body {
                /*background: rgba(0, 0, 0, 0) linear-gradient(135deg, rgb(249, 241, 232) 0%, rgb(205, 214, 227) 100%) repeat scroll 0% 0%;*/
                background: rgba(0, 0, 0, 0) linear-gradient(135deg, 
                rgb(90, 87, 83) 0%, rgb(50, 53, 56) 100%) repeat scroll 0% 0%;
                color:white;
                box-sizing: border-box;
                font-family: Arial, Helvetica, sans-serif;
            }
            video {
                width: 100%;;
            }
            #user-list {
                    display: flex;
                    flex-wrap: wrap;
                }

            @media all and (orientation:landscape) {
                .user-panel {
                    position: relative;
                    width: 33%;
                }
    
            }

            @media all and (orientation:portrait) {
                .user-panel {
                    position: relative;
                    width: 50%;
                }
            }

            #join-button {
                display:block;
                margin:auto;
                font-size:32px;
                width: 50%;
                left: 25%;
            }
        </style>
    </head>
    <body>
        <span id="connected-status">not connected</span><br>
        <div id="user-list">
            <div id="you" class="user-panel">
                <div id="your-name"></div>
            </div>
    
        </div>
        <div id="activity-log"></div>

        <script src="/socket.io/socket.io.js"></script>
        <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
        <script src="omgrtc.js"></script>
        <button id="join-button">Join</button>
        <script>
            
        var joinButton = document.getElementById("join-button")
        joinButton.onclick = () => {
            rt.getUserMedia(video => {
                you.appendChild(video)
                rt.join(roomName, userName)
            })
            joinButton.style.display = "none"
        }

        var userName = window.location.search.slice(1) || (Math.round(Math.random() * 100000) + "")
        var roomName = "public"
        if (userName.indexOf("/") > -1) {
            roomName = userName.split("/")[0]
            userName = userName.split("/")[1]
        }
        var connectedStatusEl = document.getElementById("connected-status")
        document.getElementById("your-name").innerHTML = userName

        var userListEl = document.getElementById('user-list')


        var rt = new OMGRealTime()
        rt.acceptAllCalls = true

        var activityLog = document.getElementById("activity-log")
        var log = text => {
            activityLog.innerHTML = text + "<br>" + activityLog.innerHTML
        }

        rt.onjoined = (users) => {
            console.log("onjoined!!!!!!")
            connectedStatusEl.innerHTML = "connected"
            for (var user in users) {
                rt.callUser(user)
            }
        }

        
        rt.onNewUser = (name, user) => {
            log(name + " joined")
            userEl = document.createElement("div")
            userEl.className = "user-panel"
            nameEl = document.createElement("div")
            nameEl.className = "user-name"
            nameEl.innerHTML = name
            videoEl = user.video
            userEl.appendChild(nameEl)
            userEl.appendChild(videoEl)
            userListEl.appendChild(userEl)
            user.div = userEl
        }
        
        rt.onRemoveUser = (name, user) => {
            log(name + " disconnected")
            userListEl.removeChild(user.div)
        }
        
        rt.onDisconnect = () => {
            connectedStatusEl.innerHTML = "not connected"
        };


        </script>
    </body>
</html>